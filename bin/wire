#!/usr/bin/env bash
# Wiring script to deploy dotfiles from repo to $HOME
#
# This script:
# 1. Creates symlinks from ~/.<dir> to _home/<dir> for script directories
# 2. Injects managed sections into shell RC files
# 3. Copies _home/.config files to ~/.config with conflict resolution
#
# The managed sections contain a single source command pointing to the
# corresponding file in _home/ (without the dot prefix).

set -euo pipefail

# Dynamically determine dotfiles directory from script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATES_DIR="$DOTFILES_DIR/templates"

HOME_DIR="$HOME"

# Managed section markers
MARKER_BEGIN="# BEGIN: Managed by dotfiles wire"
MARKER_END="# END: Managed by dotfiles wire"

echo "Wiring dotfiles from $DOTFILES_DIR to $HOME_DIR..."
echo "Dotfiles directory: $DOTFILES_DIR"

# =============================================================================
# Directory Symlinks
# =============================================================================

create_symlink() {
  local src="$1"
  local dest="$2"

  if [[ -d "$src" ]]; then
    ln -sfn "$src" "$dest"
    echo "  $dest → $src"
  else
    echo "  Warning: Source directory does not exist: $src"
  fi
}

echo ""
echo "Creating directory symlinks..."

# Create ~/.dotfiles symlink to the dotfiles repo
ln -sfn "$DOTFILES_DIR" "$HOME_DIR/.dotfiles"
echo "  $HOME_DIR/.dotfiles → $DOTFILES_DIR"

create_symlink "$DOTFILES_DIR/_home/profile.d" "$HOME_DIR/.profile.d"
create_symlink "$DOTFILES_DIR/_home/interactive.d" "$HOME_DIR/.interactive.d"
create_symlink "$DOTFILES_DIR/_home/startup.d" "$HOME_DIR/.startup.d"
create_symlink "$DOTFILES_DIR/_home/update.d" "$HOME_DIR/.update.d"

# =============================================================================
# Managed Sections in Shell RC Files
# =============================================================================

# Inject or update a managed section in a file
# Usage: inject_managed_section <target_file> <template_file>
inject_managed_section() {
  local target="$1"
  local template="$2"

  if [[ ! -f "$template" ]]; then
    echo "  Warning: Template not found: $template"
    return 1
  fi

  # Build the managed section content with DOTFILES_DIR expanded
  local section_content
  section_content="$MARKER_BEGIN
export DOTFILES_DIR=\"$DOTFILES_DIR\"
$(cat "$template")
$MARKER_END"

  # Create target file if it doesn't exist
  if [[ ! -f "$target" ]]; then
    echo "$section_content" > "$target"
    echo "  Created $target with managed section"
    return 0
  fi

  # Check if managed section already exists
  if grep -q "$MARKER_BEGIN" "$target" 2>/dev/null; then
    # Replace existing managed section
    local tmpfile content_file
    tmpfile=$(mktemp)
    content_file=$(mktemp)

    # Write content to temp file (awk can't handle newlines in -v)
    echo "$section_content" > "$content_file"

    # Use awk to replace the section, reading replacement from file
    awk -v begin="$MARKER_BEGIN" -v end="$MARKER_END" -v cfile="$content_file" '
      $0 ~ begin { skip=1; while ((getline line < cfile) > 0) print line; close(cfile); next }
      $0 ~ end { skip=0; next }
      !skip { print }
    ' "$target" > "$tmpfile"

    mv "$tmpfile" "$target"
    rm -f "$content_file"
    echo "  Updated managed section in $target"
  else
    # Append managed section to end of file
    echo "" >> "$target"
    echo "$section_content" >> "$target"
    echo "  Appended managed section to $target"
  fi
}

echo ""
echo "Injecting managed sections into shell RC files..."

# Zsh files
inject_managed_section "$HOME_DIR/.zshrc" "$TEMPLATES_DIR/zsh/rc.zsh"
inject_managed_section "$HOME_DIR/.zshenv" "$TEMPLATES_DIR/zsh/env.zsh"
inject_managed_section "$HOME_DIR/.zprofile" "$TEMPLATES_DIR/zsh/profile.zsh"

# Bash files
inject_managed_section "$HOME_DIR/.bashrc" "$TEMPLATES_DIR/bash/rc.bash"
inject_managed_section "$HOME_DIR/.bash_profile" "$TEMPLATES_DIR/bash/profile.bash"

# =============================================================================
# .config Directory Copying
# =============================================================================

# Copy a single file from repo to HOME with conflict resolution
# Usage: copy_config_file <relative_path>
copy_config_file() {
  local rel_path="$1"
  local src="$DOTFILES_DIR/_home/.config/$rel_path"
  local dest="$HOME_DIR/.config/$rel_path"
  local dest_dir
  dest_dir="$(dirname "$dest")"

  # Skip README files - they're for documentation only
  if [[ "$(basename "$rel_path")" == "README.md" ]]; then
    return 0
  fi

  # Create destination directory if needed
  if [[ ! -d "$dest_dir" ]]; then
    mkdir -p "$dest_dir"
  fi

  # If destination doesn't exist, just copy
  if [[ ! -f "$dest" ]]; then
    cp "$src" "$dest"
    echo "  Created: ~/.config/$rel_path"
    return 0
  fi

  # If files are identical, skip
  if diff -q "$src" "$dest" > /dev/null 2>&1; then
    echo "  Unchanged: ~/.config/$rel_path"
    return 0
  fi

  # Files differ - prompt user
  echo ""
  echo "  CONFLICT: ~/.config/$rel_path differs from repo version"
  echo ""
  echo "  --- Diff (repo vs home) ---"
  diff -u "$src" "$dest" | head -50 || true
  echo "  --- End diff ---"
  echo ""
  echo "  Options:"
  echo "    [r] Overwrite HOME with repo version"
  echo "    [h] Overwrite repo with HOME version (and commit)"
  echo "    [s] Skip (keep both as-is)"
  echo "    [d] Show full diff"
  echo ""

  while true; do
    read -rp "  Choice [r/h/s/d]: " choice
    case "$choice" in
      r|R)
        cp "$src" "$dest"
        echo "  Overwrote ~/.config/$rel_path with repo version"
        break
        ;;
      h|H)
        cp "$dest" "$src"
        git -C "$DOTFILES_DIR" add "$src"
        git -C "$DOTFILES_DIR" commit -m "sync: update _home/.config/$rel_path from HOME"
        echo "  Updated repo with ~/.config/$rel_path and committed"
        break
        ;;
      s|S)
        echo "  Skipped ~/.config/$rel_path"
        break
        ;;
      d|D)
        echo ""
        diff -u "$src" "$dest" || true
        echo ""
        ;;
      *)
        echo "  Invalid choice. Please enter r, h, s, or d."
        ;;
    esac
  done
}

echo ""
echo "Copying .config files..."

# Collect files into array first (avoids stdin redirection issues with interactive prompts)
mapfile -d '' config_files < <(find "$DOTFILES_DIR/_home/.config" -type f -print0)

for file in "${config_files[@]}"; do
  # Get relative path from _home/.config/
  rel_path="${file#$DOTFILES_DIR/_home/.config/}"
  copy_config_file "$rel_path"
done

# =============================================================================
# Summary
# =============================================================================

echo ""
echo "Wiring complete!"
echo ""
echo "Next steps:"
echo "  1. Open a new terminal to test the changes"
echo "  2. Verify functions work: cc-tmp, cc-newsession, cc-resume"
echo "  3. Check iTerm profile switching when changing directories"
echo ""
echo "To run startup scripts manually:"
echo "  $DOTFILES_DIR/bin/run-startup.sh"
