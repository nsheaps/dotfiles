#!/usr/bin/env bash
# Dotfiles management script for shell configuration

set -euo pipefail

# Dynamically determine dotfiles directory from script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATES_DIR="$SCRIPT_DIR/templates"

# Export these for use in templates
export PROFILE_D="$HOME/.profile.d"  # Symlink to _home/profile.d
export INTERACTIVE_D="$HOME/.interactive.d"  # Symlink to _home/interactive.d

case "${1:-}" in
  init)
    # Output shell code to be sourced via: eval "$(dotfiles init)"
    # Check if the calling shell is interactive and output appropriate code

    # Always source profile.d for all shells
    cat "$TEMPLATES_DIR/source-profile.sh"

    # Only source interactive.d for interactive shells
    # The $- variable contains 'i' for interactive shells
    # Note: This check happens here in the script, not in the output
    if [[ "${-}" == *i* ]] || [[ "${PS1:-}" ]]; then
      echo ""
      cat "$TEMPLATES_DIR/source-interactive.sh"
    fi
    ;;

  sync)
    # TODO: Sync managed sections of RC files
    echo "sync command not yet implemented" >&2
    exit 1
    ;;

  *)
    echo "Usage: dotfiles {init|sync}" >&2
    echo "" >&2
    echo "  init  - Output shell code for sourcing (use: eval \"\$(dotfiles init)\")" >&2
    echo "  sync  - Sync managed sections of RC files" >&2
    exit 1
    ;;
esac
