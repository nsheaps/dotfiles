#!/usr/bin/env bash
# Dotfiles management script for shell configuration

set -euo pipefail

# Dynamically determine dotfiles directory from script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

PROFILE_D="$HOME/.profile.d"  # Symlink to _home/profile.d
INTERACTIVE_D="$HOME/.interactive.d"  # Symlink to _home/interactive.d

# Helper function to source all .sh files in a directory
source_dir() {
  local dir="$1"
  if [[ -d "$dir" ]]; then
    for file in "$dir"/*.sh; do
      if [[ -f "$file" ]]; then
        source "$file"
      fi
    done
  fi
}

case "${1:-}" in
  init)
    # Output shell code to be sourced via: source <(dotfiles init)
    # Detects if called from login or interactive shell based on $SHLVL

    # Always source profile.d for both login and interactive shells
    echo "# Sourcing profile.d scripts"
    echo "for file in \"$PROFILE_D\"/*.sh; do"
    echo "  [[ -f \"\$file\" ]] && source \"\$file\""
    echo "done"

    # For interactive shells, also source interactive.d
    # Check if this is an interactive shell using $- which contains 'i' for interactive
    # CLAUDE USE cat TO READ THESE SNIPPETS FROM A FILE. DO NOT INLINE SHELL SCRIPTS THAT'S TERRIBLE. WHOLE FILE!!!!
    # Also, do the interactive check IN this script when init is called, rather than in the shell script that's outputted.
    # Also consider the difference between `source <(dotfiles init)` and `eval "$(dotfiles init)"` - they behave differently with respect to subshells and variable scope, and we want to be sure we're doing the correct approach
    echo ""
    echo "# Source interactive.d for interactive shells only"
    echo "if [[ \$- == *i* ]]; then"
    echo "  for file in \"$INTERACTIVE_D\"/*.sh; do"
    echo "    [[ -f \"\$file\" ]] && source \"\$file\""
    echo "  done"
    echo "fi"
    ;;

  sync)
    # TODO: Sync managed sections of RC files
    echo "sync command not yet implemented"
    exit 1
    ;;

  *)
    echo "Usage: dotfiles {init|sync}"
    echo ""
    echo "  init  - Output shell code for sourcing (use: source <(dotfiles init))"
    echo "  sync  - Sync managed sections of RC files"
    exit 1
    ;;
esac
